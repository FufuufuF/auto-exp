# MCP 工具使用规则

## 工具简介

项目中配置了 `richtext-reader` MCP 工具，用于读取富文本格式的文件。

## 配置信息

MCP 配置文件位置：`.cursor/mcp.json`

```json
{
    "mcpServers": {
        "richtext-reader": {
            "command": "uv",
            "args": [
                "run",
                "mcp/richtext_reader.py"
            ],
            "cwd": "${workspaceFolder}"
        }
    }
}
```

## 工具功能

### read_richtext 工具

**功能**：读取富文本文件并返回文本内容

**参数**：
- `file_path`（必需）：文件的绝对路径或相对路径
- `read_method`（可选）：读取模式，默认为 "py"
  - `"py"`：使用 Python 库解析（推荐）
  - `"LLM"`：使用云端大模型解析

**支持的文件格式**：
- `.docx`：Microsoft Word 文档
- `.pdf`：PDF 文档
- `.pptx`：Microsoft PowerPoint 演示文稿

## 使用策略

### 1. 优先使用 py 模式

**原因**：
- 速度快，不依赖网络
- 成本低，不消耗 API 调用额度
- 对于格式规范的文档，准确率高

**示例调用**：
```
使用 richtext-reader MCP 工具读取文件：
- file_path: "/path/to/document.docx"
- read_method: "py"
```

### 2. py 模式返回的内容格式

py 模式返回的是**纯文本**内容，特点：
- 没有 markdown 格式
- 没有标题层级
- 可能缺少部分格式信息（如表格、图片等）
- 需要你手动整理为 markdown

**判断 py 模式是否可用**：
- ✅ 可用：能提取出主要文本内容，即使格式混乱
- ❌ 不可用：返回乱码、提取失败、或内容完全无意义

### 3. 何时使用 LLM 模式

**使用场景**：
- py 模式返回的内容完全不可用（乱码、提取失败）
- 文档格式复杂，包含大量表格、图表
- 文档结构特殊，py 模式无法正确解析

**注意事项**：
- LLM 模式需要配置环境变量（QWEN_BASE_URL、DASHSCOPE_API_KEY、QWEN_MODEL_NAME）
- 调用速度较慢
- 消耗 API 额度
- 返回的是 markdown 格式内容，可以直接使用

**示例调用**：
```
使用 richtext-reader MCP 工具读取文件：
- file_path: "/path/to/document.docx"
- read_method: "LLM"
```

### 4. LLM 模式返回的内容格式

LLM 模式返回的是**markdown 格式**内容，特点：
- 已经包含标题、列表等 markdown 语法
- 结构化程度高
- 可以直接保存为 .md 文件
- 但仍需检查内容准确性

## 使用流程

### 标准使用流程

1. **扫描目录**，确定需要读取的文件
2. **首次尝试**：使用 py 模式读取
3. **检查结果**：
   - 如果内容基本可读，进行整理后使用
   - 如果内容完全不可用，使用 LLM 模式重新读取
4. **内容整理**：
   - py 模式：需要手动整理为 markdown 格式
   - LLM 模式：检查并微调 markdown 格式
5. **保存文件**：保存到对应的 `cursor/` 目录

### 文件路径规则

- **推荐使用绝对路径**：`/Users/haoxuan.huang/Desktop/workspace/demo/luangao/py/auto-exp/background/xxx.pdf`
- 也可以使用相对路径：`background/xxx.pdf`（相对于项目根目录）

### 批量处理策略

当需要读取多个文件时：
1. 逐个文件调用 MCP 工具
2. 每个文件读取后立即整理并保存
3. 记录哪些文件使用了 py 模式，哪些使用了 LLM 模式
4. 如果遇到读取失败，记录错误并告知用户

## 内容整理规范

### py 模式内容整理

当使用 py 模式读取文件后，需要将纯文本整理为 markdown：

**整理要点**：
1. **添加标题层级**：
   - 根据内容识别主标题、副标题
   - 使用 `#`、`##`、`###` 等标记
2. **段落分隔**：
   - 保持段落之间的空行
   - 合并不必要的换行
3. **列表格式化**：
   - 将列表项转为 markdown 列表（`-` 或 `1.`）
4. **代码块**：
   - 识别代码片段，用 ``` 包裹
   - 标注代码语言
5. **表格**：
   - 如果原文有表格，尽量转为 markdown 表格格式
6. **特殊内容标注**：
   - 图片位置：`![描述](原文图片引用)`
   - 重要内容：使用 `**粗体**` 或 `> 引用`

### LLM 模式内容检查

LLM 模式返回的已经是 markdown，但仍需检查：
1. **内容完整性**：是否遗漏重要内容
2. **格式正确性**：标题层级是否合理
3. **代码块**：代码语法是否正确
4. **特殊字符**：是否有转义错误

## 错误处理

### 常见错误

1. **文件路径错误**：
   - 检查文件是否存在
   - 确认路径格式正确

2. **文件格式不支持**：
   - 仅支持 .docx、.pdf、.pptx
   - 如果是其他格式，需要转换

3. **LLM 模式配置缺失**：
   - 检查 .env 文件是否配置了 API Key
   - 检查环境变量是否正确加载

4. **读取超时或失败**：
   - 检查文件是否损坏
   - 尝试使用另一种模式
   - 如果都失败，告知用户手动处理

### 错误报告

当 MCP 工具调用失败时，需要：
1. 记录失败的文件路径
2. 记录失败的原因
3. 尝试使用另一种模式
4. 如果仍然失败，明确告知用户：
   ```
   ⚠️ 文件读取失败：
   - 文件：background/xxx.pdf
   - 原因：[错误信息]
   - 建议：请手动检查文件是否损坏，或提供其他格式
   ```

## 使用示例

### 示例 1：读取 Word 文档

```
1. 调用 MCP 工具：
   - file_path: "/Users/.../background/实验背景.docx"
   - read_method: "py"

2. 得到纯文本内容后，整理为 markdown：
   - 添加标题
   - 格式化段落
   - 保存为 background/cursor/实验背景.md
```

### 示例 2：读取 PDF 文档（py 模式失败）

```
1. 首次尝试（py 模式）：
   - 返回内容乱码或不完整

2. 二次尝试（LLM 模式）：
   - file_path: "/Users/.../background/理论知识.pdf"
   - read_method: "LLM"
   - 得到 markdown 格式内容
   - 检查内容并保存为 background/cursor/理论知识.md
```

### 示例 3：读取 PPT 文档

```
1. 调用 MCP 工具：
   - file_path: "/Users/.../background/课程讲义.pptx"
   - read_method: "py"

2. 整理内容：
   - PPT 通常是幻灯片形式
   - 每页添加分隔标记
   - 保持要点列表格式
   - 保存为 background/cursor/课程讲义.md
```
